networks:
  audio_text_bridge:
    driver: bridge
    ipam:
      config:
        - subnet: 169.254.9.0/24

services:
  app:
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: dev
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.2
        aliases:
          - "audio-text-backend.app"
    ports:
      - 3203:3203
    volumes:
      # Only mount source code for development (not dependencies)
      - ./audio_text_backend:/app/audio_text_backend
      - ./alembic:/app/alembic
      - ./config.ini:/app/config.ini
      - /app/audio_text_backend.egg-info/
    env_file:
      - .env
    environment:
      # Prevent Python from writing .pyc files and buffer output
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    image: postgres:17.1-alpine
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.3
        aliases:
          - "audio-text-backend.db"
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./pgsql/init.d:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.4
        aliases:
          - "audio-text-backend.cache"
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --save 60 1000
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Default single worker (listens to ALL queues - recommended for simple setups)
  celery-worker:
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: dev
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.5
        aliases:
          - "audio-text-backend.celery"
    volumes:
      - ./audio_text_backend:/app/audio_text_backend
      - ./config.ini:/app/config.ini
    env_file:
      - .env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    command: uv run celery -A audio_text_backend.celery.app worker --loglevel=info --concurrency=2
    profiles: ["default"]

  # Dedicated worker for small models (dev multi-queue testing)
  celery-worker-small:
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: dev
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.6
        aliases:
          - "audio-text-backend.celery-small"
    volumes:
      - ./audio_text_backend:/app/audio_text_backend
      - ./config.ini:/app/config.ini
    env_file:
      - .env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    command: uv run celery -A audio_text_backend.celery.app worker --loglevel=info --concurrency=4 -Q audio_small
    profiles: ["multi-queue"]

  # Dedicated worker for medium models (dev multi-queue testing)
  celery-worker-medium:
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: dev
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.7
        aliases:
          - "audio-text-backend.celery-medium"
    volumes:
      - ./audio_text_backend:/app/audio_text_backend
      - ./config.ini:/app/config.ini
    env_file:
      - .env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    command: uv run celery -A audio_text_backend.celery.app worker --loglevel=info --concurrency=2 -Q audio_medium
    profiles: ["multi-queue"]

  # Dedicated worker for large models (dev multi-queue testing)
  celery-worker-large:
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: dev
    networks:
      audio_text_bridge:
        ipv4_address: 169.254.9.8
        aliases:
          - "audio-text-backend.celery-large"
    volumes:
      - ./audio_text_backend:/app/audio_text_backend
      - ./config.ini:/app/config.ini
    env_file:
      - .env
    environment:
      - C_FORCE_ROOT=true
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    command: uv run celery -A audio_text_backend.celery.app worker --loglevel=info --concurrency=1 -Q audio_large
    profiles: ["multi-queue"]

  # TODO not working yet, connection to redis issue
  # flower:
  #   image: mher/flower:2.0
  #   networks:
  #     audio_text_bridge:
  #       ipv4_address: 169.254.9.8
  #       aliases:
  #         - "audio-text-backend.flower"
  #   ports:
  #     - "5555:5555"
  #   environment:
  #     - CELERY_BROKER_URL=redis://audio-text-backend.cache:6379/0
  #     - FLOWER_PORT=5555
  #     - C_FORCE_ROOT="true"
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #     celery-worker:
  #       condition: service_started
  #   command: celery flower --broker=redis://audio-text-backend.cache:6379/0 --port=5555

volumes:
  redis_data:
  postgres_data:
